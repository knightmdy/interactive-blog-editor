import { saveAs } from 'file-saver'
import JSZip from 'jszip'
import type { Document, ExportConfig } from '@/types'

// å¯¼å‡ºå·¥å…·ç±»
export class ExportUtils {
  // å¯¼å‡ºä¸º HTML
  static async exportAsHTML(doc: Document, config: ExportConfig = {
    format: 'html',
    includeCSS: true,
    minify: false
  }): Promise<void> {
    try {
      console.log('ğŸŒ ç”ŸæˆHTMLå†…å®¹...')
      const html = this.generateHTML(doc, config)
      console.log('ğŸ“ HTMLå†…å®¹é•¿åº¦:', html.length)
      
      console.log('ğŸ’¾ åˆ›å»ºBlobå¯¹è±¡...')
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' })
      
      const filename = `${doc.title || 'document'}.html`
      console.log('ğŸ’¿ å¼€å§‹ä¸‹è½½æ–‡ä»¶:', filename)
      saveAs(blob, filename)
      console.log('âœ… HTMLå¯¼å‡ºæˆåŠŸ')
    } catch (error) {
      console.error('âŒ HTMLå¯¼å‡ºå¤±è´¥:', error)
      throw new Error(`HTMLå¯¼å‡ºå¤±è´¥: ${error instanceof Error ? error.message : 'Unknown error'}`)
    }
  }


  // å¯¼å‡ºä¸ºé™æ€ç«™ç‚¹
  static async exportAsStaticSite(doc: Document): Promise<void> {
    try {
      console.log('ğŸ“¦ å‡†å¤‡é™æ€ç«™ç‚¹å¯¼å‡º...')
      const zip = new JSZip()
      
      // ç”Ÿæˆ HTML æ–‡ä»¶
      console.log('ğŸŒ ç”Ÿæˆindex.html...')
      const html = this.generateHTML(doc, { 
        format: 'html', 
        includeCSS: true, 
        minify: false 
      })
      zip.file('index.html', html)
      console.log('âœ… index.html å·²æ·»åŠ åˆ°ZIP')
      
      // æ·»åŠ æ ·å¼æ–‡ä»¶
      console.log('ğŸ¨ ç”Ÿæˆstyles.css...')
      const css = this.generateCSS()
      zip.file('styles.css', css)
      console.log('âœ… styles.css å·²æ·»åŠ åˆ°ZIP')
      
      // æ·»åŠ  JavaScript æ–‡ä»¶
      console.log('âš¡ ç”Ÿæˆscript.js...')
      const js = this.generateJS()
      zip.file('script.js', js)
      console.log('âœ… script.js å·²æ·»åŠ åˆ°ZIP')
      
      // æ·»åŠ é…ç½®æ–‡ä»¶
      console.log('ğŸ“‹ ç”Ÿæˆpackage.json...')
      const packageJson = this.generatePackageJson(doc)
      zip.file('package.json', packageJson)
      console.log('âœ… package.json å·²æ·»åŠ åˆ°ZIP')
      
      console.log('ğŸ“– ç”ŸæˆREADME.md...')
      const readme = this.generateReadme(doc)
      zip.file('README.md', readme)
      console.log('âœ… README.md å·²æ·»åŠ åˆ°ZIP')
      
      // ç”Ÿæˆå¹¶ä¸‹è½½ ZIP æ–‡ä»¶
      console.log('ğŸ—œï¸ å‹ç¼©ZIPæ–‡ä»¶...')
      const blob = await zip.generateAsync({ type: 'blob' })
      
      const filename = `${doc.title || 'blog-site'}.zip`
      console.log('ğŸ’¿ å¼€å§‹ä¸‹è½½ZIPæ–‡ä»¶:', filename)
      saveAs(blob, filename)
      console.log('âœ… é™æ€ç«™ç‚¹å¯¼å‡ºæˆåŠŸ')
    } catch (error) {
      console.error('âŒ é™æ€ç«™ç‚¹å¯¼å‡ºå¤±è´¥:', error)
      throw new Error(`é™æ€ç«™ç‚¹å¯¼å‡ºå¤±è´¥: ${error instanceof Error ? error.message : 'Unknown error'}`)
    }
  }

  // ç”Ÿæˆ HTML å†…å®¹
  private static generateHTML(doc: Document, config: ExportConfig): string {
    const title = doc.title || 'Untitled Document'
    const content = this.processMarkdownContent(doc.content)
    
    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <meta name="description" content="Generated by Interactive Blog Editor">
    <meta name="generator" content="Interactive Blog Editor">
    ${config.includeCSS ? this.getInlineCSS() : '<link rel="stylesheet" href="styles.css">'}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="site-title">${title}</h1>
            <div class="meta">
                <time datetime="${doc.createdAt.toISOString()}">
                    ${this.formatDate(doc.createdAt)}
                </time>
                ${doc.tags.length > 0 ? `
                <div class="tags">
                    ${doc.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
                ` : ''}
            </div>
        </header>
        
        <main class="content">
            <article class="article">
                ${content}
            </article>
        </main>
        
        <footer class="footer">
            <p>Generated by <a href="#" target="_blank">Interactive Blog Editor</a></p>
        </footer>
    </div>
    
    <script>
        ${this.getInteractiveJS()}
    </script>
</body>
</html>`
  }

  // å¤„ç† Markdown å†…å®¹ - ä½¿ç”¨ç®€å•è§£æ
  private static processMarkdownContent(content: string): string {
    try {
      // ç®€åŒ–çš„Markdownè§£æï¼Œç¡®ä¿åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­å¯é å·¥ä½œ
      let html = content
        // å¤„ç†æ ‡é¢˜
        .replace(/^#{6}\s+(.+)$/gm, '<h6>$1</h6>')
        .replace(/^#{5}\s+(.+)$/gm, '<h5>$1</h5>')
        .replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>')
        .replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>')
        .replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>')
        .replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>')
        
        // å¤„ç†ç²—ä½“å’Œæ–œä½“
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        
        // å¤„ç†è¡Œå†…ä»£ç 
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        
        // å¤„ç†é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, href) => {
          const isExternal = this.isExternalLink(href)
          const targetAttr = isExternal ? ' target="_blank" rel="noopener noreferrer"' : ''
          const externalIcon = isExternal ? ' <span class="external-link-icon">â†—</span>' : ''
          return `<a href="${href}"${targetAttr}>${text}${externalIcon}</a>`
        })
        
        // å¤„ç†å›¾ç‰‡
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;" />')
        
        // å¤„ç†ä»£ç å—
        .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
          const language = lang || 'text'
          const escapedCode = this.escapeHtml(code.trim())
          
          // ç‰¹æ®Šå¤„ç†å›¾è¡¨ä»£ç å—
          if (language === 'chart') {
            try {
              const config = JSON.parse(code.trim())
              const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`
              
              return `
                <div class="chart-container" id="${chartId}" data-config='${JSON.stringify(config)}'>
                  <div class="chart-header">
                    <span class="chart-type">${config.type || 'Chart'}</span>
                  </div>
                  <div class="chart-canvas" style="height: 300px;"></div>
                </div>
              `
            } catch (err) {
              return `<div class="error-block">å›¾è¡¨é…ç½®è§£æé”™è¯¯</div>`
            }
          }
          
          return `<pre><code class="language-${language}">${escapedCode}</code></pre>`
        })
        
        // å¤„ç†è¡¨æ ¼
        .replace(/\|(.+)\|\n\|[-\s|]+\|\n((?:\|.+\|\n?)*)/g, (match, header, body) => {
          const headerCells = header.split('|').map(cell => `<th>${cell.trim()}</th>`).join('')
          const bodyRows = body.trim().split('\n').map(row => {
            const cells = row.split('|').map(cell => `<td>${cell.trim()}</td>`).join('')
            return `<tr>${cells}</tr>`
          }).join('')
          
          return `
            <div class="table-wrapper">
              <table class="markdown-table">
                <thead><tr>${headerCells}</tr></thead>
                <tbody>${bodyRows}</tbody>
              </table>
            </div>
          `
        })
        
        // å¤„ç†åˆ—è¡¨
        .replace(/^\* (.+)$/gm, '<li>$1</li>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        
        // å¤„ç†æ®µè½
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
      
      // åŒ…è£…åœ¨æ®µè½æ ‡ç­¾ä¸­
      if (!html.includes('<h') && !html.includes('<div') && !html.includes('<pre')) {
        html = `<p>${html}</p>`
      }
      
      return html
    } catch (error) {
      console.warn('Markdown processing failed:', error)
      return `<p>${this.escapeHtml(content)}</p>`
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå¤–é“¾
  private static isExternalLink(href: string): boolean {
    try {
      const url = new URL(href, window.location.href)
      return url.hostname !== window.location.hostname
    } catch {
      return false
    }
  }
  
  // HTML è½¬ä¹‰
  private static escapeHtml(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
  }

  // è·å–å†…è”CSS
  private static getInlineCSS(): string {
    return `<style>
      ${this.generateCSS()}
    </style>`
  }

  // ç”ŸæˆCSSæ ·å¼
  private static generateCSS(): string {
    return `
/* åŸºç¡€æ ·å¼ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #fff;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e5e7eb;
}

.site-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1rem;
}

.meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    color: #6b7280;
    font-size: 0.875rem;
}

.tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    background: #3b82f6;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
}

/* å†…å®¹æ ·å¼ */
.content {
    margin-bottom: 3rem;
}

.article {
    prose: true;
}

.article h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin: 2rem 0 1rem 0;
    line-height: 1.2;
}

.article h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin: 1.5rem 0 0.75rem 0;
    line-height: 1.3;
}

.article h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin: 1.25rem 0 0.5rem 0;
    line-height: 1.4;
}

.article p {
    margin: 1rem 0;
    color: #374151;
    line-height: 1.7;
}

.article code {
    background: #f3f4f6;
    color: #dc2626;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', 'Consolas', monospace;
    font-size: 0.875em;
}

.article pre {
    background: #1f2937;
    color: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1rem 0;
}

.article pre code {
    background: transparent;
    color: inherit;
    padding: 0;
}

.article blockquote {
    border-left: 4px solid #3b82f6;
    background: #f8fafc;
    padding: 1rem;
    margin: 1rem 0;
    color: #4b5563;
    font-style: italic;
}

.article ul, .article ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

.article li {
    margin: 0.5rem 0;
    color: #374151;
}

.article a {
    color: #3b82f6;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.article a:hover {
    border-bottom-color: #3b82f6;
}

.article img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1rem 0;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.article table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    overflow-x: auto;
    display: block;
    white-space: nowrap;
}

.article th,
.article td {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    text-align: left;
}

.article th {
    background: #f9fafb;
    font-weight: 600;
    color: #1f2937;
}

/* åº•éƒ¨æ ·å¼ */
.footer {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
    color: #6b7280;
    font-size: 0.875rem;
}

.footer a {
    color: #3b82f6;
    text-decoration: none;
}

.footer a:hover {
    text-decoration: underline;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .site-title {
        font-size: 2rem;
    }
    
    .meta {
        flex-direction: column;
        gap: 0.5rem;
    }
}

/* æ‰“å°æ ·å¼ */
@media print {
    @page {
        margin: 1in;
        size: A4;
    }
    
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.5;
        color: #000;
        background: #fff;
    }
    
    .container {
        max-width: none;
        padding: 0;
        margin: 0;
    }
    
    .header {
        margin-bottom: 1.5rem;
        page-break-after: avoid;
    }
    
    .site-title {
        font-size: 18pt;
        margin-bottom: 0.5rem;
    }
    
    .meta {
        font-size: 10pt;
        margin-bottom: 1rem;
    }
    
    .article h1 {
        font-size: 16pt;
        page-break-after: avoid;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .article h2 {
        font-size: 14pt;
        page-break-after: avoid;
        margin-top: 0.8rem;
        margin-bottom: 0.4rem;
    }
    
    .article h3 {
        font-size: 12pt;
        page-break-after: avoid;
        margin-top: 0.6rem;
        margin-bottom: 0.3rem;
    }
    
    .article p {
        margin: 0.5rem 0;
        orphans: 3;
        widows: 3;
    }
    
    .article pre {
        page-break-inside: avoid;
        background: #f5f5f5 !important;
        border: 1px solid #ddd !important;
        padding: 0.5rem !important;
        font-size: 10pt;
        margin: 0.5rem 0;
    }
    
    .article code {
        background: #f5f5f5 !important;
        padding: 0.1rem 0.2rem !important;
        font-size: 10pt;
    }
    
    .article table {
        page-break-inside: avoid;
        font-size: 10pt;
        border-collapse: collapse;
        width: 100%;
        margin: 0.5rem 0;
    }
    
    .article th,
    .article td {
        border: 1px solid #000 !important;
        padding: 0.3rem !important;
    }
    
    .article th {
        background: #f0f0f0 !important;
        font-weight: bold;
    }
    
    .article img {
        max-width: 100% !important;
        page-break-inside: avoid;
        margin: 0.5rem 0;
    }
    
    .article blockquote {
        border-left: 3px solid #000 !important;
        background: #f9f9f9 !important;
        padding: 0.5rem !important;
        margin: 0.5rem 0;
        page-break-inside: avoid;
    }
    
    .article ul,
    .article ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }
    
    .article li {
        margin: 0.2rem 0;
    }
    
    .article a {
        color: #000 !important;
        text-decoration: underline !important;
        border-bottom: none !important;
    }
    
    .article a[href]:after {
        content: " (" attr(href) ")";
        font-size: 9pt;
        color: #666;
    }
    
    .footer {
        display: none;
    }
    
    .chart-container {
        page-break-inside: avoid;
        border: 1px solid #ddd !important;
        margin: 0.5rem 0;
        padding: 0.5rem;
    }
    
    .chart-canvas {
        background: #fff !important;
    }
    
    .tag {
        border: 1px solid #000 !important;
        background: #f0f0f0 !important;
        color: #000 !important;
    }
}
`
  }

  // ç”Ÿæˆäº¤äº’å¼JavaScript
  private static getInteractiveJS(): string {
    return `
// åˆå§‹åŒ–é¡µé¢
window.document.addEventListener('DOMContentLoaded', function() {
    // ä»£ç é«˜äº®
    if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
    }
    
    // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
    renderAllCharts();
});

// å›¾è¡¨æ¸²æŸ“
function renderAllCharts() {
    if (typeof echarts === 'undefined') return;
    
    const chartContainers = window.document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        try {
            const config = JSON.parse(container.getAttribute('data-config'));
            const chartCanvas = container.querySelector('.chart-canvas');
            
            if (chartCanvas) {
                const chart = echarts.init(chartCanvas);
                chart.setOption(config);
                
                // å“åº”å¼è°ƒæ•´
                window.addEventListener('resize', function() {
                    chart.resize();
                });
            }
        } catch (error) {
            console.error('Chart rendering failed:', error);
            container.innerHTML = '<div class="error-block">å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>';
        }
    });
}

function renderChart(element, config) {
    if (typeof echarts !== 'undefined') {
        const chart = echarts.init(element);
        chart.setOption(config);
        
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }
}

// è¡¨æ ¼æ’åº
window.document.querySelectorAll('table').forEach(table => {
    const headers = table.querySelectorAll('th');
    headers.forEach((header, index) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => sortTable(table, index));
    });
});

function sortTable(table, column) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const sorted = rows.sort((a, b) => {
        const aText = a.cells[column].textContent.trim();
        const bText = b.cells[column].textContent.trim();
        
        if (!isNaN(aText) && !isNaN(bText)) {
            return parseFloat(aText) - parseFloat(bText);
        }
        
        return aText.localeCompare(bText);
    });
    
    tbody.innerHTML = '';
    sorted.forEach(row => tbody.appendChild(row));
}

// å›¾ç‰‡ç¼©æ”¾
window.document.querySelectorAll('img').forEach(img => {
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', function() {
        if (this.style.transform === 'scale(1.5)') {
            this.style.transform = 'scale(1)';
            this.style.cursor = 'zoom-in';
        } else {
            this.style.transform = 'scale(1.5)';
            this.style.cursor = 'zoom-out';
        }
    });
});

// å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
window.document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = window.document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
`
  }

  // ç”Ÿæˆ package.json
  private static generatePackageJson(doc: Document): string {
    return JSON.stringify({
      name: this.slugify(doc.title || 'blog-site'),
      version: '1.0.0',
      description: `Static blog site generated from "${doc.title}"`,
      main: 'index.html',
      scripts: {
        serve: 'python -m http.server 8000',
        deploy: 'echo "Deploy to your preferred hosting service"'
      },
      keywords: ['blog', 'static-site', 'markdown'],
      author: 'Interactive Blog Editor',
      license: 'MIT',
      devDependencies: {
        'http-server': '^14.1.1'
      }
    }, null, 2)
  }

  // ç”Ÿæˆ README.md
  private static generateReadme(doc: Document): string {
    return `# ${doc.title || 'Blog Site'}

This is a static blog site generated by [Interactive Blog Editor](https://github.com/your-repo/interactive-blog-editor).

## Quick Start

1. Serve the site locally:
   \`\`\`bash
   # Using Python
   python -m http.server 8000
   
   # Using Node.js
   npx http-server
   \`\`\`

2. Open your browser and visit \`http://localhost:8000\`

## Deployment

You can deploy this static site to any web hosting service:

- **GitHub Pages**: Upload to a GitHub repository and enable Pages
- **Netlify**: Drag and drop the folder to Netlify
- **Vercel**: Import the folder as a new project
- **Firebase Hosting**: Use Firebase CLI to deploy

## Content

- **Created**: ${this.formatDate(doc.createdAt)}
- **Last Updated**: ${this.formatDate(doc.updatedAt)}
- **Tags**: ${doc.tags.join(', ') || 'None'}

---

Generated by Interactive Blog Editor
`
  }

  // ç”Ÿæˆ JavaScript æ–‡ä»¶
  private static generateJS(): string {
    return this.getInteractiveJS()
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  private static formatDate(date: Date): string {
    return new Intl.DateTimeFormat('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date)
  }

  // è½¬æ¢ä¸ºURLå‹å¥½çš„å­—ç¬¦ä¸²
  private static slugify(text: string): string {
    return text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/[\s_-]+/g, '-')
      .replace(/^-+|-+$/g, '')
  }
}